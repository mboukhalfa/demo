{% extends "base.html" %}

{% block head_title %}
{{ title }} | {{ block.super }}
{% endblock head_title %}


{% block content %}
 <form action="" method="POST">
 	{% csrf_token %}
	Select a Video: <input type="file" accept='video/*' name="video" class="upload-video">
  <input type="submit" value="upload">
</form> 



{% endblock content %}

{% block script %}
<script>
$(document).ready(function(){

    // setup session cookie data. This is Django-related
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    // end session cookie data setup. 


	// auto-upload on file input change.
	$(document).on('change','.upload-video', function(event){
	    var selectedVideo = $(this).prop('files')[0];
	    	alert(selectedVideo)
	        var video = verifyVideo(selectedVideo)
	        if (video){
	            uploadFile(video)
	        } else {
	             alert("file selected is not allowed video.")
	        }
	    });

	function verifyVideo(file){
	    // verifies the file extension is one we support.
	    var extension = file.name.split('.').pop().toLowerCase(); //file.substr( (file.lastIndexOf('.') +1) );
	    switch(extension) {
	        case 'mov':
	        case 'mp4':
	        case 'mpeg4':
	        case 'avi':
            case 'webm':
	            return file

	        default:
	            //snotAllowedFiles.push(file)
	            return null
	    }
	}
    
    function constructFormData(data, fileItem) {
		var contentType = fileItem.type
		var filename = data.filename
		//var repsonseUser = data.user
		var keyPath = 'www/' + '/' + filename
		// var keyPath = policyData.file_bucket_path
		var fd = new FormData()
		fd.append('key', keyPath + filename);
		// fd.append('acl','private');
		fd.append('Content-Type', contentType);
		fd.append("token", data.key)
		fd.append('filename', filename);
		fd.append('file', fileItem);
		return fd
	}
    function uploadFile(fileItem){
        var data = {
		url:'http://ss.dcm-ovs.com:8080/upload/',
        };

        $.ajax({
            type:"POST",
            data: { // TODO: send to server side file name and maybe md5 of file also type mime and size
                filename: fileItem.name
            }, // TODO: maybe i can use datatype
            url: "{% url 'upload:upload' %}",
            dataType : "json",
            success: function(revievedData){
                    alert("success: "+jQuery.type(revievedData))
            },
            error: function(data){
                alert("An error occured, please try again later")
            }
        }).done(function(){
            // construct the needed data
            var fd = constructFormData(data, fileItem)

            // use XML http Request to Send to AWS. 
            var xhr = new XMLHttpRequest()

            // construct callback for when uploading starts
            // xhr.upload.onloadstart = function(event){
            //     var inLoadingIndex = $.inArray(fileItem, fileItemList)
            //     if (inLoadingIndex == -1){
            //         // Item is not loading, add to inProgress queue
            //         newLoadingItem = {
            //             file: fileItem,
            //             id: policyData.file_id,
            //             order: fileItemList.length + 1
            //         }
            //         fileItemList.push(newLoadingItem)
            //       }
            //     fileItem.xhr = xhr
            // }

            // Monitor upload progress and attach to fileItem.
            xhr.upload.addEventListener("progress", function(event){
                if (event.lengthComputable) {
                 var progress = Math.round(event.loaded / event.total * 100);
                    fileItem.progress = progress
                    console.log("progress = "+ progress)
                }
            })

            xhr.upload.addEventListener("load", function(event){
                console.log("Complete")
                // handle FileItem Upload being complete.
                // fileUploadComplete(fileItem, policyData)

            })

            xhr.open('POST', data.url , true);
            xhr.send(fd);
 })
}});
 </script>
{% endblock script %}